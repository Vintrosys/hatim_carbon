[
 {
  "allow_guest": 0,
  "api_method": "Get Delivery Note Items",
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Save",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2026-01-19 20:18:43.648453",
  "module": null,
  "name": "shipment",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Shipment",
  "script": "delivery_note = frappe.form_dict.get(\"delivery_note\")\n\nif not delivery_note:\n    frappe.throw(\"Delivery Note is required\")\n\ndn = frappe.get_doc(\"Delivery Note\", delivery_note)\ndn.flags.ignore_permissions = True\n\nitems = []\n\nfor d in dn.items:\n    # âœ… Use REAL child doctype table name\n    used_qty = frappe.db.sql(\"\"\"\n        SELECT COALESCE(SUM(sb.qty), 0)\n        FROM `tabShipment Box` sb\n        INNER JOIN `tabShipment` s ON s.name = sb.parent\n        WHERE\n            s.docstatus = 1\n            AND sb.delivery_note = %s\n            AND sb.item_code = %s\n    \"\"\", (delivery_note, d.item_code))[0][0]\n\n    remaining_qty = d.qty - used_qty\n\n    if remaining_qty <= 0:\n        continue\n\n    items.append({\n        \"delivery_note\": delivery_note,\n        \"item_code\": d.item_code,\n        \"item_name\": d.item_name,\n        \"description\": d.description,\n        \"qty\": remaining_qty,\n        \"uom\": d.uom,\n        \"rate\": d.rate,\n        \"used_qty\": used_qty\n    })\n\nif not items:\n    frappe.throw(\n        \"All items from this Delivery Note are already fully linked to Shipments\"\n    )\n\nfrappe.response[\"message\"] = items\n",
  "script_type": "API"
 }
]