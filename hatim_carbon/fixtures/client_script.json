[
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Shipment",
  "enabled": 1,
  "modified": "2026-01-23 16:17:55.835599",
  "module": null,
  "name": "shipment",
  "script": "// /* ============================================================\n//   Shipment Outer Box → Select Inner Boxes\n// ============================================================ */\n// frappe.ui.form.on(\"Shipment Outer Box\", {\n//     select_inner_boxes(frm, cdt, cdn) {\n//         const ob = locals[cdt][cdn];\n\n//         const boxes = (frm.doc.custom_shipment_box || []).map(b => ({\n//             label: `${b.inner_box_no} (GW: ${b.gross_weight}, NW: ${b.net_weight})`,\n//             value: b.inner_box_no\n//         }));\n\n//         if (!boxes.length) {\n//             frappe.msgprint(\"No Inner Boxes available\");\n//             return;\n//         }\n\n//         const dialog = new frappe.ui.Dialog({\n//             title: __(\"Select Inner Boxes\"),\n//             fields: [\n//                 {\n//                     fieldtype: \"MultiCheck\",\n//                     fieldname: \"inner_boxes\",\n//                     label: \"Inner Boxes\",\n//                     options: boxes\n//                 }\n//             ],\n//             primary_action_label: __(\"Update Outer Box\"),\n//             primary_action(values) {\n//                 const selected = values.inner_boxes || [];\n\n//                 if (!selected.length) {\n//                     frappe.msgprint(\"Select at least one Inner Box\");\n//                     return;\n//                 }\n\n//                 let gross = 0;\n//                 let net = 0;\n\n//                 // Reset previous mapping for this outer box\n//                 (frm.doc.custom_shipment_box || []).forEach(b => {\n//                     if (b.outer_box === ob.outer_box_no) {\n//                         b.outer_box = \"\";\n//                     }\n//                 });\n\n//                 // Map selected inner boxes\n//                 (frm.doc.custom_shipment_box || []).forEach(b => {\n//                     if (selected.includes(b.inner_box_no)) {\n//                         b.outer_box = ob.outer_box_no;\n//                         gross += flt(b.gross_weight);\n//                         net += flt(b.net_weight);\n//                     }\n//                 });\n\n//                 // Update Shipment Outer Box\n//                 frappe.model.set_value(cdt, cdn, \"inner_box\", selected.join(\", \"));\n//                 frappe.model.set_value(cdt, cdn, \"gross_weight\", gross);\n//                 frappe.model.set_value(cdt, cdn, \"net_weight\", net);\n\n//                 frm.refresh_field(\"custom_shipment_box\");\n//                 frm.refresh_field(\"custom_outer_box\");\n\n//                 dialog.hide();\n//             }\n//         });\n\n//         dialog.show();\n//     }\n// });\n\n\n// /* ============================================================\n//   Shipment → Fetch Items from Delivery Note\n// ============================================================ */\n// frappe.ui.form.on(\"Shipment\", {\n//     refresh(frm) {\n//         frm.add_custom_button(__('Fetch Items from Delivery Note'), () => {\n\n//             frappe.prompt(\n//                 [\n//                     {\n//                         fieldname: 'delivery_note',\n//                         fieldtype: 'Link',\n//                         options: 'Delivery Note',\n//                         label: 'Delivery Note',\n//                         reqd: 1\n//                     }\n//                 ],\n//                 function (prompt_values) {\n\n//                     const selected_dn = prompt_values.delivery_note;\n\n//                     frappe.call({\n//                         method: \"Get Delivery Note Items\",\n//                         args: {\n//                             delivery_note: selected_dn\n//                         },\n//                         callback: function (r) {\n\n//                             const dn_items = r.message || [];\n\n//                             if (!dn_items.length) {\n//                                 frappe.msgprint(__('No items available for this Delivery Note'));\n//                                 return;\n//                             }\n\n//                             const dialog = new frappe.ui.Dialog({\n//                                 title: __('Select Items from Delivery Note'),\n//                                 size: 'large',\n//                                 fields: [\n//                                     {\n//                                         fieldname: 'items',\n//                                         fieldtype: 'Table',\n//                                         label: __('Items'),\n//                                         cannot_add_rows: true,\n//                                         in_place_edit: true,\n//                                         data: dn_items.map(d => ({\n//                                             select: 1,\n//                                             item_code: d.item_code,\n//                                             item_name: d.item_name,\n//                                             description: d.description,\n//                                             qty: d.qty,\n//                                             uom: d.uom,\n//                                             rate: d.rate\n//                                         })),\n//                                         fields: [\n//                                             { fieldtype: 'Check', fieldname: 'select', in_list_view: 1 },\n//                                             { fieldtype: 'Data', fieldname: 'item_code', label: 'Item Code', read_only: 1, in_list_view: 1 },\n//                                             { fieldtype: 'Data', fieldname: 'item_name', label: 'Item Name', read_only: 1, in_list_view: 1 },\n//                                             { fieldtype: 'Float', fieldname: 'qty', label: 'Qty', in_list_view: 1 },\n//                                             { fieldtype: 'Data', fieldname: 'uom', label: 'UOM', read_only: 1, in_list_view: 1 }\n//                                         ]\n//                                     }\n//                                 ],\n//                                 primary_action_label: __('Add to Shipment'),\n//                                 primary_action(values) {\n\n//                                     const selected = (values.items || []).filter(\n//                                         row => row.select && row.qty > 0\n//                                     );\n\n//                                     if (!selected.length) {\n//                                         frappe.msgprint(__('Please select at least one item'));\n//                                         return;\n//                                     }\n\n//                                     selected.forEach(row => {\n//                                         const child = frm.add_child('custom_shipment_box');\n//                                         child.delivery_note = selected_dn;\n//                                         child.item_code = row.item_code;\n//                                         child.item_description = row.description;\n//                                         child.qty = row.qty;\n//                                         child.packed = 0;\n//                                         child.gross_weight = 0;\n//                                         child.net_weight = 0;\n//                                     });\n\n//                                     frm.refresh_field('custom_shipment_box');\n//                                     dialog.hide();\n//                                 }\n//                             });\n\n//                             dialog.show();\n//                         }\n//                     });\n//                 },\n//                 __('Select Delivery Note'),\n//                 __('Fetch Items')\n//             );\n//         });\n//     }\n// });\n\nfrappe.ui.form.on(\"Shipment\", {\n    refresh(frm) {\n        frm.add_custom_button(__('Fetch Items from Delivery Note'), () => {\n\n            if (!frm.doc.delivery_customer) {\n                frappe.msgprint(__('Please select Delivery Customer first'));\n                return;\n            }\n\n            frappe.prompt(\n                [\n                    {\n                        fieldname: 'delivery_note',\n                        fieldtype: 'Link',\n                        options: 'Delivery Note',\n                        label: 'Delivery Note',\n                        reqd: 1,\n                        get_query: function () {\n                            return {\n                                filters: {\n                                    customer: frm.doc.delivery_customer,\n                                    docstatus: 1\n                                }\n                            };\n                        }\n                    }\n                ],\n                function (prompt_values) {\n\n                    const selected_dn = prompt_values.delivery_note;\n\n                    frappe.call({\n                        method: \"Get Delivery Note Items\",\n                        args: {\n                            delivery_note: selected_dn\n                        },\n                        callback: function (r) {\n\n                            const dn_items = r.message || [];\n\n                            if (!dn_items.length) {\n                                frappe.msgprint(__('No items available for this Delivery Note'));\n                                return;\n                            }\n\n                            const dialog = new frappe.ui.Dialog({\n                                title: __('Select Items from Delivery Note'),\n                                size: 'large',\n                                fields: [\n                                    {\n                                        fieldname: 'items',\n                                        fieldtype: 'Table',\n                                        label: __('Items'),\n                                        cannot_add_rows: true,\n                                        in_place_edit: true,\n                                        data: dn_items.map(d => ({\n                                            select: 1,\n                                            item_code: d.item_code,\n                                            item_name: d.item_name,\n                                            description: d.description,\n                                            qty: d.qty,\n                                            uom: d.uom,\n                                            rate: d.rate\n                                        })),\n                                        fields: [\n                                            { fieldtype: 'Check', fieldname: 'select', in_list_view: 1 },\n                                            { fieldtype: 'Data', fieldname: 'item_code', read_only: 1, in_list_view: 1 },\n                                            { fieldtype: 'Data', fieldname: 'item_name', read_only: 1, in_list_view: 1 },\n                                            { fieldtype: 'Float', fieldname: 'qty', in_list_view: 1 },\n                                            { fieldtype: 'Data', fieldname: 'uom', read_only: 1, in_list_view: 1 }\n                                        ]\n                                    }\n                                ],\n                                primary_action_label: __('Add to Shipment'),\n                                primary_action(values) {\n\n                                    const selected = (values.items || []).filter(\n                                        row => row.select && row.qty > 0\n                                    );\n\n                                    if (!selected.length) {\n                                        frappe.msgprint(__('Please select at least one item'));\n                                        return;\n                                    }\n\n                                    selected.forEach(row => {\n                                        const child = frm.add_child('custom_shipment_box');\n                                        child.delivery_note = selected_dn;\n                                        child.item_code = row.item_code;\n                                        child.item_description = row.description;\n                                        child.qty = row.qty;\n                                        child.packed = 0;\n                                        child.gross_weight = 0;\n                                        child.net_weight = 0;\n                                    });\n\n                                    frm.refresh_field('custom_shipment_box');\n                                    dialog.hide();\n                                }\n                            });\n\n                            dialog.show();\n                        }\n                    });\n                },\n                __('Select Delivery Note'),\n                __('Fetch Items')\n            );\n        });\n    }\n});\n\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Shipment",
  "enabled": 0,
  "modified": "2026-01-19 20:22:10.221993",
  "module": null,
  "name": "outer box calculation",
  "script": "\nfrappe.ui.form.on(\"Shipment Outer Box\", {\n    select_inner_boxes(frm, cdt, cdn) {\n        const ob = locals[cdt][cdn];\n\n        const boxes = (frm.doc.custom_shipment_box || []).map(b => ({\n            label: `${b.inner_box_no} (GW: ${b.gross_weight}, NW: ${b.net_weight})`,\n            value: b.inner_box_no\n        }));\n\n        if (!boxes.length) {\n            frappe.msgprint(\"No Inner Boxes available\");\n            return;\n        }\n\n        const dialog = new frappe.ui.Dialog({\n            title: __(\"Select Inner Boxes\"),\n            fields: [{\n                fieldtype: \"MultiCheck\",\n                fieldname: \"inner_boxes\",\n                label: \"Inner Boxes\",\n                options: boxes\n            }],\n            primary_action_label: __(\"Update Outer Box\"),\n            primary_action(values) {\n                const selected = values.inner_boxes || [];\n\n                if (!selected.length) {\n                    frappe.msgprint(\"Select at least one Inner Box\");\n                    return;\n                }\n\n                let gross = 0;\n                let net = 0;\n\n                // Reset previous mapping for this outer box\n                (frm.doc.custom_shipment_box || []).forEach(b => {\n                    if (b.outer_box === ob.outer_box_no) {\n                        b.outer_box = \"\";\n                    }\n                });\n\n                // Map selected inner boxes\n                (frm.doc.custom_shipment_box || []).forEach(b => {\n                    if (selected.includes(b.inner_box_no)) {\n                        b.outer_box = ob.outer_box_no;\n                        gross += flt(b.gross_weight);\n                        net += flt(b.net_weight);\n                    }\n                });\n\n                // ✅ UPDATE Shipment Outer Box\n                frappe.model.set_value(cdt, cdn, \"inner_box\", selected.join(\", \"));\n                frappe.model.set_value(cdt, cdn, \"gross_weight\", gross);\n                frappe.model.set_value(cdt, cdn, \"net_weight\", net);\n\n                frm.refresh_field(\"custom_shipment_box\");\n                frm.refresh_field(\"custom_outer_box\");\n\n                dialog.hide();\n            }\n        });\n\n        dialog.show();\n    }\n});\n",
  "view": "Form"
 }
]